<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ì¸ í˜ì´ì§€</title>
    <link rel="stylesheet" href="/main.css">
    <style>
        .hidden { display: none; }
        .friend-card { padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px; }
        .friend-card p { margin: 4px 0; }
        .btn-ghost { background: transparent; border: 1px solid #ccc; padding: 6px 10px; border-radius: 4px; }
    </style>
</head>
<body>
<header>
    <h1>í™˜ì˜í•©ë‹ˆë‹¤!</h1>
    <nav>
        <a href="/main">í™ˆ</a>
        <a href="/profile">í”„ë¡œí•„</a>
        <a href="/logout" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
        <a href="/dashboard">ëŒ€ì‹œë³´ë“œ</a>
    </nav>
</header>

<main id="main-content">
    <section class="welcome-section">
        <h2>ì•ˆë…•í•˜ì„¸ìš”, ì‚¬ìš©ìë‹˜!</h2>
        <p>ì´ê³³ì€ ë©”ì¸ í˜ì´ì§€ì…ë‹ˆë‹¤. ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì´ìš©í•´ë³´ì„¸ìš”.</p>
    </section>

    <section class="cards">
        <div class="card">
            <h3>ì¹œêµ¬</h3>
            <p>ìƒˆë¡œìš´ ì¹œêµ¬ê°€ ì¶”ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì¸í•´ë³´ì„¸ìš”!</p>
            <button id="friend" type="button" onclick="openFriends()">ìì„¸íˆ ë³´ê¸°</button>
        </div>
        <div class="card">
            <h3>ê³µì§€ì‚¬í•­</h3>
            <p>ìƒˆë¡œìš´ ê³µì§€ê°€ ìˆìŠµë‹ˆë‹¤. í™•ì¸í•´ë³´ì„¸ìš”!</p>
            <button id="notice" type="button" onclick="openSchedule()">ìì„¸íˆ ë³´ê¸°</button>
        </div>
        <div class="card">
            <h3>ì—…ë°ì´íŠ¸</h3>
            <p>ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
            <button id="update" type="button">ìì„¸íˆ ë³´ê¸°</button>
        </div>
        <div class="card">
            <h3>ë¬¸ì˜</h3>
            <p>ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ë©´ ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
            <button id="call" type="button">ë¬¸ì˜í•˜ê¸°</button>
        </div>
    </section>
</main>

<section id="schedule" class="hidden" tabindex="-1" aria-hidden="true">
    <h2>ğŸ“… ìš°ë¦¬ë“¤ì˜ ì¼ì •</h2>
    <p>ì—¬ê¸°ì— ì¼ì • ëª©ë¡ì„ í‘œì‹œí•©ë‹ˆë‹¤.</p>
    <button type="button">ìƒˆ ì¼ì • ì¶”ê°€í•˜ê¸°</button>
    <div>
        <button type="button" class="btn-ghost" onclick="backToMain()">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</section>

<section id="friends" class="hidden" tabindex="-1" aria-hidden="true">
    <h2>ì¹œêµ¬</h2>
    <button id="friendadd" type="button" onclick="openFriendList()">â• ì¹œêµ¬ ëª©ë¡</button>
    <div id="friends-find" style="margin-top:12px;"></div>
    <div style="margin:8px 0">
        <button type="button" class="btn-ghost" onclick="backToMain()">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</section>

<section id="friendlist" class="hidden" tabindex="-1" aria-hidden="true">
    <div id="friend-items" aria-live="polite"></div>
    <div style="margin:8px 0">
        <button id="load-friends-btn" type="button" class="btn-ghost">ì¶”ì²œ ì¹œêµ¬ ìƒˆë¡œê³ ì¹¨</button>
        <button type="button" class="btn-ghost" onclick="backToMain()">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</section>

<footer>
    <p>&copy; 2025 My Project. All rights reserved.</p>
</footer>

<script>
/* -------------------- ê³µí†µ í•¨ìˆ˜ -------------------- */
function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
}

async function sendFriendRequest(friendId) {
    try {
        const res = await fetch('/db/addFriend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ friendId })
        });
        const json = await res.json();
        return res.ok && json.success;
    } catch (err) {
        console.error('sendFriendRequest error', err);
        return false;
    }
}

function createPersonCard(person, opts = {}) {
    const { showAddButton = true, addButtonText = 'â• ì¹œêµ¬ ìš”ì²­', onAdd = null } = opts;
    const itemBox = document.createElement('div');
    itemBox.className = 'person-card';
    itemBox.style.cssText = `
        display:flex; justify-content:space-between; align-items:center;
        max-width:600px; border:1px solid #ccc; border-radius:12px;
        padding:16px; margin-bottom:12px; background-color:#fff;
        box-shadow:0 2px 6px rgba(0,0,0,0.06);
    `;

    const infoBox = document.createElement('div');
    infoBox.style.cssText = 'display:flex; flex-direction:column; flex:1; max-width:70%; margin-right:12px;';

    const nameEl = document.createElement('h3');
    nameEl.textContent = escapeHtml(person.name || person.id || '');
    nameEl.style.marginBottom = "6px";

    const categoryEl = document.createElement("div");
    categoryEl.textContent = `ê´€ì‹¬: ${escapeHtml(person.hobby || 'ì¹œêµ¬')}`;
    categoryEl.style.color = "#555";
    categoryEl.style.fontSize = "15px";

    const profileEl = document.createElement("p");
    profileEl.textContent = escapeHtml(person.profile_text || '');
    profileEl.style.fontSize = "14px";
    profileEl.style.margin = "6px 0";

    const phoneEl = document.createElement("div");
    phoneEl.innerHTML = person.phone ? `ì—°ë½ì²˜: <a href="tel:${escapeHtml(person.phone)}">${escapeHtml(person.phone)}</a>` : 'ì—°ë½ì²˜: ì—†ìŒ';
    phoneEl.style.fontSize = "14px";
    phoneEl.style.color = "#666";

    infoBox.appendChild(nameEl);
    infoBox.appendChild(categoryEl);
    infoBox.appendChild(profileEl);
    infoBox.appendChild(phoneEl);

    const actionBox = document.createElement("div");
    actionBox.style.display = "flex";
    actionBox.style.flexDirection = "column";
    actionBox.style.alignItems = "flex-end";
    actionBox.style.gap = "8px";

    if (showAddButton && typeof onAdd === 'function') {
        const addBtn = document.createElement("button");
        addBtn.type = 'button';
        addBtn.textContent = addButtonText;
        addBtn.style.cssText = `
            margin-top:10px; padding:8px 14px; border-radius:8px;
            background-color:#00796B; color:#fff; border:0; cursor:pointer;
        `;
        addBtn.addEventListener('click', async () => await onAdd(person, addBtn, itemBox));
        actionBox.appendChild(addBtn);
    }

    itemBox.appendChild(infoBox);
    itemBox.appendChild(actionBox);
    return itemBox;
}

/* -------------------- ì¹œêµ¬ ì„¹ì…˜ ë Œë” -------------------- */
function renderFriendSections(list) {
    const friendsFindEl = document.getElementById('friends-find');
    const friendItemsEl = document.getElementById('friend-items');
    friendsFindEl.innerHTML = '';
    friendItemsEl.innerHTML = '<br><h1>ì¶”ì²œ ì¹œêµ¬ ëª©ë¡</h1>';

    list.forEach(person => {
        if (person.isFriend) {
            // ì´ë¯¸ ì¹œêµ¬
            const card = createPersonCard(person, { showAddButton: false });
            friendsFindEl.appendChild(card);
        } else {
            // ì•„ì§ ì¹œêµ¬ê°€ ì•„ë‹Œ ê²½ìš°
            const card = createPersonCard(person, {
                showAddButton: true,
                onAdd: async (p, btn, cardEl) => {
                    if (!confirm(`${p.name || p.id}ë‹˜ì—ê²Œ ì¹œêµ¬ ìš”ì²­ì„ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                    btn.disabled = true;
                    btn.textContent = 'ìš”ì²­ì¤‘...';
                    const ok = await sendFriendRequest(p.id);
                    if (ok) {
                        btn.textContent = 'ìš”ì²­ ì™„ë£Œ';
                        btn.style.background = 'gray';
                        // ì¹œêµ¬ë¡œ ì´ë™
                        document.getElementById('friends-find').appendChild(cardEl);
                    } else {
                        btn.disabled = false;
                        btn.textContent = 'â• ì¹œêµ¬ ìš”ì²­';
                        alert('ì¹œêµ¬ ìš”ì²­ ì‹¤íŒ¨');
                    }
                }
            });
            friendItemsEl.appendChild(card);
        }
    });

    if (friendItemsEl.children.length === 2) friendItemsEl.innerHTML += "<br><p>ì¶”ì²œ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    if (friendsFindEl.children.length === 0) friendsFindEl.innerHTML = "<p>ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
}

/* -------------------- ì¹œêµ¬ ë°ì´í„° ë¡œë“œ -------------------- */
async function loadFriendlist() {
    try {
        const res = await fetch('/db/getFriends', { method: 'GET', credentials: 'include' });
        if (!res.ok) return;
        const json = await res.json();
        const list = Array.isArray(json.data) ? json.data : [];
        renderFriendSections(list);
    } catch (err) {
        console.error(err);
    }
}

/* -------------------- ì„¹ì…˜ ì „í™˜ -------------------- */
const sections = {
    main: document.getElementById('main-content'),
    schedule: document.getElementById('schedule'),
    friends: document.getElementById('friends'),
    friendlist: document.getElementById('friendlist')
};

const onShow = {
    friends: () => loadFriendlist(),
    friendlist: () => loadFriendlist()
};

function showSection(name, push = true) {
    Object.entries(sections).forEach(([key, el]) => {
        el.classList.toggle('hidden', key !== name);
        el.setAttribute('aria-hidden', (key !== name).toString());
    });
    if (onShow[name]) onShow[name]();
    if (push) {
        const urlHash = (name === 'main') ? location.pathname : `#${name}`;
        history.pushState({ page: name }, '', urlHash);
    }
}

function openSchedule() { showSection('schedule'); }
function openFriends() { showSection('friends'); }
function openFriendList() { showSection('friendlist'); }
function backToMain() { showSection('main'); }

/* -------------------- ë²„íŠ¼ ë° ì´ë²¤íŠ¸ -------------------- */
document.getElementById('load-friends-btn')?.addEventListener('click', loadFriendlist);
document.getElementById('logoutBtn')?.addEventListener('click', e => {
    e.preventDefault();
    localStorage.removeItem('token');
    alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
    window.location.href = '/';
});

window.addEventListener('popstate', e => {
    const page = e.state?.page || (location.hash ? location.hash.replace('#','') : 'main');
    showSection(page, false);
});

window.addEventListener('load', () => {
    const initial = location.hash ? location.hash.replace('#','') : 'main';
    showSection(initial, false);
});
</script>
</body>
</html>
