<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ì¸ í˜ì´ì§€</title>
    <link rel="stylesheet" href="/main.css">
    <style>
        .hidden { display: none; }
        .friend-card { padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px; }
        .friend-card p { margin: 4px 0; }
        .btn-ghost { background: transparent; border: 1px solid #ccc; padding: 6px 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <header>
        <h1>í™˜ì˜í•©ë‹ˆë‹¤!</h1>
        <nav>
            <a href="/main">í™ˆ</a>
            <a href="/profile">í”„ë¡œí•„</a>
            <a href="/logout" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
            <a href="/dashboard">ëŒ€ì‹œë³´ë“œ</a>
        </nav>
    </header>

    <!-- ë©”ì¸ ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ìš”ì†Œ (ìˆ¨ê¹€/í‘œì‹œ í† ê¸€ ëŒ€ìƒ) -->
    <main id="main-content">
        <section class="welcome-section">
            <h2>ì•ˆë…•í•˜ì„¸ìš”, ì‚¬ìš©ìë‹˜!</h2>
            <p>ì´ê³³ì€ ë©”ì¸ í˜ì´ì§€ì…ë‹ˆë‹¤. ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì´ìš©í•´ë³´ì„¸ìš”.</p>
        </section>
        
        <section class="cards">
            <div class="card">
                <h3>ì¹œêµ¬</h3>
                <p>ìƒˆë¡œìš´ ì¹œêµ¬ê°€ ì¶”ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì¸í•´ë³´ì„¸ìš”!</p>
                <button id="friend" type="button" onclick="openFriends()">ìì„¸íˆ ë³´ê¸°</button>
            </div>
            <div class="card">
                <h3>ê³µì§€ì‚¬í•­</h3>
                <p>ìƒˆë¡œìš´ ê³µì§€ê°€ ìˆìŠµë‹ˆë‹¤. í™•ì¸í•´ë³´ì„¸ìš”!</p>
                <button id="notice" type="button" onclick="openSchedule()">ìì„¸íˆ ë³´ê¸°</button>
            </div>
            <div class="card">
                <h3>ì—…ë°ì´íŠ¸</h3>
                <p>ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                <button id="update" type="button">ìì„¸íˆ ë³´ê¸°</button>
            </div>
            <div class="card">
                <h3>ë¬¸ì˜</h3>
                <p>ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ë©´ ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
                <button id="call" type="button">ë¬¸ì˜í•˜ê¸°</button>
            </div>
        </section>
    </main>

    <!-- í‰ì†Œì—ëŠ” ìˆ¨ê¹€. ë³´ì—¬ì¤„ ë•ŒëŠ” main-contentë¥¼ ìˆ¨ê¸°ê³  ì´ ì„¹ì…˜ë§Œ í‘œì‹œ -->
    <section id="schedule" class="hidden" tabindex="-1" aria-hidden="true">
        <h2>ğŸ“… ìš°ë¦¬ë“¤ì˜ ì¼ì •</h2>
        <p>ì—¬ê¸°ì— ì¼ì • ëª©ë¡ì„ í‘œì‹œí•©ë‹ˆë‹¤.</p>

        <button type="button">ìƒˆ ì¼ì • ì¶”ê°€í•˜ê¸°</button>
        <div>
            <button type="button" class="btn-ghost" onclick="backToMain()">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </section>

    <section id="friends" class="hidden" tabindex="-1" aria-hidden="true">
        <h2>ì¹œêµ¬</h2>
        <button id="friendadd" type="button" onclick="findNearbyFriends()">â• ì¹œêµ¬ ëª©ë¡</button>
        <p>ì¹œêµ¬ ëª©ë¡ì„ í‘œì‹œí•©ë‹ˆë‹¤.</p>

        

        <div style="margin:8px 0">
            <button id="load-friends-btn" type="button" class="btn-ghost">ì¹œêµ¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
            <button type="button" class="btn-ghost" onclick="backToMain()">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </section>

    <section id="friendlist" class="hidden" tabindex="-1" aria-hidden="true">
        <div id="friend-items" aria-live="polite"></div>
        <div id="friends-find" style="margin-top:12px;"></div>
    </section>

    <footer>
        <p>&copy; 2025 My Project. All rights reserved.</p>
    </footer>

    <script>
        function escapeHtml (str) {
            if (!str) return '';
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
        }

        async function sendFriendRequest(friendId, btnElement) {
            try {
                if (btnElement) {
                    btnElement.disabled = true;
                    const prevText = btnElement.textContent;
                    btnElement.textContent = 'ìš”ì²­ì¤‘...';

                    const res = await fetch('/db/addFriend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ friendId })
                    });
                    const json = await res.json();

                    if (res.ok && json.success) {
                        btnElement.textContent = 'ìš”ì²­ ì™„ë£Œ';
                        btnElement.style.background = 'gray';
                    } else {
                        alert(json?.message || 'ì¹œêµ¬ ìš”ì²­ ì‹¤íŒ¨');
                        btnElement.disabled = false;
                        btnElement.textContent = prevText;
                    }
                } else {
                    // btnElementê°€ ì—†ì„ ë•Œ ê°„ë‹¨ í˜¸ì¶œ í˜•íƒœ
                    const res = await fetch('/db/addFriend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ friendId })
                    });
                    const json = await res.json();
                    return res.ok && json.success;
                }
            } catch (err) {
                console.error('sendFriendRequest error', err);
                if (btnElement) {
                btnElement.disabled = false;
                btnElement.textContent = 'â• ì¹œêµ¬ ìš”ì²­';
                }
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
                return false;
            }
        }

        /* ---------- renderFriendsFind (ê±°ë¦¬ ê´€ë ¨ ì œê±°ëœ ë Œë”ëŸ¬) ---------- */
        function renderFriendsFind(list) {
            const container = document.getElementById("friends-find");
            if (!container) {
                console.warn('#friends-find ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            container.innerHTML = "";

            if (!Array.isArray(list) || list.length === 0) {
                container.innerHTML = "<p>ê·¼ì²˜ì— ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            list.forEach(person => {
                const itemBox = document.createElement("div");
                itemBox.className = 'person-item';
                itemBox.style.cssText = `
                display:flex; justify-content:space-between; align-items:center;
                max-width:600px; border:1px solid #ccc; border-radius:12px;
                padding:16px; margin-bottom:12px; background-color:#fff;
                box-shadow:0 2px 6px rgba(0,0,0,0.06);
                `;

                const infoBox = document.createElement("div");
                infoBox.style.cssText = 'display:flex; flex-direction:column; flex:1; max-width:70%; margin-right:12px;';

                const nameEl = document.createElement("h3");
                nameEl.textContent = escapeHtml(person.name || person.id || '');
                nameEl.style.marginBottom = "6px";

                const categoryEl = document.createElement("div");
                categoryEl.textContent = `ê´€ì‹¬: ${escapeHtml(person.hobby || 'ì¹œêµ¬')}`;
                categoryEl.style.color = "#555";
                categoryEl.style.fontSize = "15px";

                const profile_textEl = document.createElement("p");
                profile_textEl.textContent = escapeHtml(person.profile_text || '');
                profile_textEl.style.fontSize = "14px";
                profile_textEl.style.margin = "6px 0";

                const phoneEl = document.createElement("div");
                phoneEl.innerHTML = person.phone ? `ì—°ë½ì²˜: <a href="tel:${escapeHtml(person.phone)}">${escapeHtml(person.phone)}</a>` : 'ì—°ë½ì²˜: ì—†ìŒ';
                phoneEl.style.fontSize = "14px";
                phoneEl.style.color = "#666";

                infoBox.appendChild(nameEl);
                infoBox.appendChild(categoryEl);
                infoBox.appendChild(profile_textEl);
                infoBox.appendChild(phoneEl);

                const actionBox = document.createElement("div");
                actionBox.style.display = "flex";
                actionBox.style.flexDirection = "column";
                actionBox.style.alignItems = "flex-end";
                actionBox.style.gap = "8px";

                const addBtn = document.createElement("button");
                addBtn.type = 'button';
                addBtn.textContent = "â• ì¹œêµ¬ ìš”ì²­";
                addBtn.style.cssText = `
                margin-top:10px; padding:8px 14px; border-radius:8px;
                background-color:#00796B; color:#fff; border:0; cursor:pointer;
                `;
                addBtn.addEventListener('click', () => {
                const nameLabel = person.name || person.id || 'ì‚¬ìš©ì';
                if (!confirm(`${nameLabel}ë‹˜ì—ê²Œ ì¹œêµ¬ ìš”ì²­ì„ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                sendFriendRequest(person.id, addBtn);
                });

                actionBox.appendChild(addBtn);
                itemBox.appendChild(infoBox);
                itemBox.appendChild(actionBox);
                container.appendChild(itemBox);
            });
        }

        /* ---------- renderNearby (ê°„ë‹¨ ë Œë”ëŸ¬) ---------- */
        function renderNearby(containerId, list = []) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            if (!Array.isArray(list) || list.length === 0) {
                container.innerHTML = '<p>ê·¼ì²˜ì— ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            list.forEach(person => {
                const wrapper = document.createElement('div');
                wrapper.className = 'nearby-item';
                wrapper.style.cssText = `
                display:flex; justify-content:space-between; align-items:center;
                padding:10px; border:1px solid #eee; border-radius:8px; margin-bottom:8px;
                `;

                const info = document.createElement('div');
                info.innerHTML = `
                <div style="font-weight:600">${escapeHtml(person.name || person.id)}</div>
                <div style="font-size:13px; color:#555">ê´€ì‹¬: ${escapeHtml(person.hobby || 'ì¹œêµ¬')}</div>
                <div style="font-size:13px; color:#777">${escapeHtml(person.profile_text || '')}</div>
                `;

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = 'â• ì¹œêµ¬ ìš”ì²­';
                btn.style.cssText = `padding:6px 10px; border-radius:8px; border:0; background:#0a84ff; color:#fff; cursor:pointer;`;
                btn.addEventListener('click', async () => {
                    const confirmed = confirm(`${person.name || person.id}ë‹˜ì—ê²Œ ì¹œêµ¬ìš”ì²­ì„ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`);
                    if (!confirmed) return;
                    btn.disabled = true;
                    const originalText = btn.textContent;
                    btn.textContent = 'ìš”ì²­ì¤‘...';
                    try {
                        const res = await fetch('/db/addFriend', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ friendId: person.id })
                        });
                        const json = await res.json();
                        if (res.ok && json.success) {
                            btn.textContent = 'ìš”ì²­ ì™„ë£Œ';
                            btn.style.background = 'gray';
                        } else {
                            alert(json?.message || 'ì¹œêµ¬ ìš”ì²­ ì‹¤íŒ¨');
                            btn.disabled = false;
                            btn.textContent = originalText;
                        }
                    } catch (err) {
                        console.error(err);
                        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                });

                wrapper.appendChild(info);
                wrapper.appendChild(btn);
                container.appendChild(wrapper);
            });
        }

        /* ---------- loggedInUserId ì´ˆê¸°í™” ---------- */
        let loggedInUserId = localStorage.getItem("loggedInUser");
        document.addEventListener("DOMContentLoaded", () => {
            loggedInUserId = localStorage.getItem("loggedInUser");
        });

        /* ---------- findNearbyFriends (ê±°ë¦¬ ë¡œì§ ì—†ì´ ì„œë²„ì—ì„œ ëª©ë¡ ìš”ì²­) ---------- */
        async function findNearbyFriends() {
            showSection('friendlist');

            if (!navigator.geolocation) {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;

                try {
                // ì„œë²„ì—ì„œ ì¹œêµ¬ ëª©ë¡ì„ ê°€ì ¸ì˜´ (distance í•„ë“œ ì—†ì´ ì²˜ë¦¬)
                const res = await fetch("/db/addFriend", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ latitude, longitude }),
                });

                if (res.status === 401) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•´ìš”.");
                    return;
                }

                const result = await res.json();
                if (!result.success) {
                    alert("ì˜¤ë¥˜: " + (result.message || 'ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨'));
                    return;
                }

                const nearbyFriendsFind = result.data || [];

                const list = nearbyFriendsFind.map(f => ({
                    id: f.id,
                    name: f.name || f.id,
                    hobby: f.hobby || "ì¹œêµ¬",
                    profile_text: `ğŸ’¬ ${f.profile_text || "ê°™ì´ í™œë™í•  ì¹œêµ¬ì…ë‹ˆë‹¤."}`,
                    phone: f.phone || ""
                }));

                renderFriendsFind(list);

                } catch (err) {
                console.error('findNearbyFriends error', err);
                alert('ê·¼ì²˜ ì¹œêµ¬ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                renderFriendsFind([]);
                }
            }, (err) => {
                console.error('geolocation error', err);
                alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.');
            }, { enableHighAccuracy: true, timeout: 10000 });
        }
        


        // DOM ë ˆí¼ëŸ°ìŠ¤
        const mainEl = document.getElementById('main-content');
        const scheduleEl = document.getElementById('schedule');
        const friendsEl = document.getElementById('friends');
        const friendlistEl = document.getElementById('friendlist');
        const friendItemsEl = document.getElementById('friend-items');
        const loadFriendsBtn = document.getElementById('load-friends-btn');

        // ì¡´ì¬ í™•ì¸ ìœ í‹¸
        function exists(el) { return el instanceof Element; }

        // ì„¹ì…˜ ë§¤í•‘
        const sections = {
            main: mainEl,
            schedule: scheduleEl,
            friends: friendsEl,
            friendlist: friendlistEl
        };

        // ì„¹ì…˜ì´ ë³´ì—¬ì§ˆ ë•Œ ì‹¤í–‰í•  ì½œë°±ë“¤
        const onShow = {
            friends: () => loadFriendlist(),
            schedule: () => {/* í•„ìš” ì‹œ ì¼ì • ë¡œë“œ */},
            friendlist: () => loadFriendlist()
        };

        // ì„¹ì…˜ ë³´ì—¬ì£¼ê¸°/ìˆ¨ê¸°ê¸° ê³µìš© í•¨ìˆ˜
        function showSection(name, push = true) {
            if (!sections[name]) return;

            Object.entries(sections).forEach(([key, el]) => {
                if (!exists(el)) return;
                const isTarget = (key === name);
                el.classList.toggle('hidden', !isTarget);
                el.setAttribute('aria-hidden', (!isTarget).toString());
            });

            const target = sections[name];
            if (exists(target)) {
                try { target.focus({ preventScroll: true }); } catch(e) {}
            }

            // onShow ì½œë°± í˜¸ì¶œ (ë¹„ë™ê¸° ê°€ëŠ¥)
            if (onShow[name]) {
                try { onShow[name](); } catch(e) { console.error(e); }
            }

            if (push) {
                const urlHash = (name === 'main') ? (location.pathname + location.search) : `#${name}`;
                const stateObj = (name === 'main') ? {} : { page: name };
                history.pushState(stateObj, '', urlHash);
            }
        }

        
        // ì¹œêµ¬ ëª©ë¡ ë¡œë“œ
        async function loadFriendlist() {
            if (!friendItemsEl) return;
            friendItemsEl.innerHTML = `<br><br>
                                    <h1>ì¹œêµ¬ ì¶”ì²œ ëª©ë¡</h1>`;

            try {
                const res = await fetch('/db/getFriends', {
                    method: 'GET',
                    credentials: 'include'
                });

                // ë§Œì•½ 401ì´ë‚˜ ê¸°íƒ€ ìƒíƒœë©´ ì²˜ë¦¬
                if (res.status === 401) {
                    friendItemsEl.innerHTML = '<p>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
                    return;
                }

                const json = await res.json();

                if (!res.ok || !json.success) {
                    const msg = json?.message || 'ì¹œêµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                    friendItemsEl.innerHTML = `<p>${escapeHtml(msg)}</p>`;
                    return;
                }


            } catch (err) {
                console.error('loadFriendlist error', err);
                friendItemsEl.innerHTML = '<p>ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì¹œêµ¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        if (loadFriendsBtn) loadFriendsBtn.addEventListener('click', loadFriendlist);


        // ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì²˜ë¦¬
        window.addEventListener('popstate', (e) => {
            const page = (e.state && e.state.page) ? e.state.page : (location.hash ? location.hash.replace('#', '') : 'main');
            if (page in sections) showSection(page, false);
            else showSection('main', false);
        });

        // ë¡œë“œ ì‹œ í•´ì‹œ ëŒ€ì‘
        window.addEventListener('load', () => {
            const initial = location.hash ? location.hash.replace('#', '') : 'main';
            if (initial in sections) {
                if (initial !== 'main') history.replaceState({ page: initial }, '', `#${initial}`);
                showSection(initial, false);
            } else {
                showSection('main', false);
            }
        });

        // ì„¹ì…˜ ì˜¤í”ˆ/í´ë¡œì¦ˆ ë³´ì¡° í•¨ìˆ˜
        function openSchedule() { showSection('schedule'); }
        function openFriends() { showSection('friends'); }
        function backToMain() { showSection('main'); }
        function openFriendList() { showSection('friendlist'); }

        // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('token');
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/';
            });
        }

        // ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì—°ê²°
        if (loadFriendsBtn) loadFriendsBtn.addEventListener('click', loadFriendlist);
    </script>
</body>
</html>
